---
title: "Linuxディストリビューターとしての1年間の活動を振り返る"
emoji: "🧗"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["oss", "nix"]
published: true
---

## 始めに

この1年ほどLinuxディストリビューションの一つである、NixOSのディストリビューターとして活動してきた。
正確にはNixOSが採用するパッケージマネージャーであるNixが利用するパッケージリポジトリ、nixpkgsで活動している。
Nixとは再現性、宣言的、信頼性におもきをおいたパッケージマネージャーであり、NixOS上だけではなくUbuntuやArch Linuxといった他のLinuxディストリビューションでも既定のパッケージマネージャーと競合することなく導入できる。
この点においてはFlatpakやSnap、AppImageと同じ感覚である。
さらにNixはLinuxだけでなく、macOSやBSD上でも動作する。WSLを使えばWindows上でも動作するし、Windows向けのバイナリをクロスコンパイルすることも簡単だ。
(ただしWindowsへのクロスコンパイルはほとんど実用的ではない。)
1年ほど前にはdevboxというのが話題になったこともあるので聞いたことがある人も多いかもしれない。
2023年には特に多くの日本語による解説記事が書かれていたように思うため、詳細はほかの記事に譲る。
nixpkgsはパッケージマネージャーとしてのNixを支える中心的なリポジトリであり、flakeの台頭によってパッケージの分散化が進む2024年初春現在においても切っても切り離せない存在である。

[repology](https://repology.org/)によるとnixpkgsは世界最大の収録数を誇るリポジトリであり、その膨大さは以下のグラフが物語っている。
[![repology](https://repology.org/graph/map_repo_size_fresh.svg)](https://repology.org/repositories/graphs)
2024年3月1日現在、nixpkgsに収録されているパッケージの数は90,366個であり、次点のAURは73223個である。
Archに含まれるパッケージは11,215個なのでそれらを合わせても6,000個ほどnixpkgsのほうが多い。
また参考までに、もう時期リリースされるUbuntuのLTS、24.04のパッケージ数は36,972個、macOSで人気のHomebrewは6,792個である。

[![Star History](https://api.star-history.com/svg?repos=NixOS/nixpkgs&type=Date)](https://star-history.com/#NixOS/nixpkgs&Date)
2024年3月1日現在、nixpkgsのGitHubリポジトリは14,859のスターを獲得しており、それは急速に増え続けている。

そのようなリポジトリでおよそ1年前から積極的に貢献を始め、2023年の8月からコミッターとして活動しているので、Nixの布教も兼ねてこの1年の振り返りを書いていきたい。

## nixpkgsに貢献するまで

そもそも私とNixとの出会いは2017年にまでさかのぼる。
そもそも私は2017年12月ころにはNixを知っており、サブのラップトップにNixOSを導入していたらしい。
直後に大学院の冬季入試を控えたタイミングのため、現実逃避のために奇怪なLinuxディストリビューションに手を出したのだろう。
しかしLinuxにはじめて触れて1年少々の私にはあまりにもNixOSは荷が重すぎたのか、私のdotfileには1週間分の履歴だけが残っていた。
当時はまだHome Managerやnix-darwinなどのプロジェクトも発展しておらず、少なくとも当時の私にはNixOS以外でNixを使うという選択肢はなかった。
[Tokyo-NixOS](https://www.meetup.com/ja-JP/tokyo-nixos-meetup/)([GitHub](https://www.meetup.com/ja-JP/tokyo-nixos-meetup/))というコミュニティもちょうど私がNixの門戸を叩いたときには活動停止していたように見えた。
Nixに関する日本語の情報は上記のTokyo-NixOSの資料以外になく、
NVIDIAのGPUを搭載したXiaomi製の無名のラップトップを使用していたのも良くなかった。
（今もこのラップトップは検証目的に時折利用している。OSはもちろんNixOSである。）
し方なくあこがれを抱きながらNixOSを闇に葬り去った。

そこから数年が経ち、風の噂でNixの存在を思い出した私は2021年の8月にNixを本格的に再導入した。今度はnix-darwinを添えて。

転機が訪れたのはちょうど1年前、2023年の3月のことであった。その日はNixの日本語コミュニティでNixOS上のIMEのバグについて話していた。
幸いその修正は簡単で、運良く1週間ほどでレビュー、マージしてもらうことができた。
しかしこれまでの経験上PRが埋もれてしまい、適切な修正やアップデートがいつも受け入れられるとは到底思えなかった。
https://github.com/NixOS/nixpkgs/pull/138255
例えばこのPRは2021-09-17に投稿し、2022-07-16にマージされた。なにもレビューに時間がかかっていたわけではなく、ただ埋もれてしまっていただけだ。
特にIMEのようなパッケージは、Nixのコミュニティの大多数を占めるラテン文字を扱う人々にとってそれほど重要ではない。
こうしたパッケージを滞りなくメンテナンスするためには何かしらの工夫が必要だった。

普段若さにかまけてドブに捨てている時間をかき集めはじめた。

## コミッターになるまで

2023年はNixとの距離を縮めることができた1年だった。
この1年間のコミット数はマージコミットを含めると2133で、9番目に多い結果となった。
https://github.com/NixOS/nixpkgs/graphs/contributors?from=2023-03-01&to=2024-02-29&type=c

nixpkgsのPRにはいくつか種類があって、
r-ryantmというbotアカウントによる自動アップデートはコミット権限がなければ見る必要性は薄い。
自分がメンテナーとなっているパッケージに対してPRがくれば動作確認するくらいで良い。
このPR群はほとんどの場合ただの単純なアップデートであり、ビルドできればそのままマージされることが多い。

そこで人の手によって提出されるPRをレビューすることとなる。
nixpkgsの構成上、Pythonライブラリに対するPRは非常に多い。偶然私はPythonのライブラリに多少明るかったため、これらのPRに焦点を当てて貢献することにした。

Nixのコミュニティでは公式のフォーラムとしてdiscourceを利用している。
https://discourse.nixos.org/t/prs-ready-for-review/3032
https://discourse.nixos.org/t/prs-already-reviewed/2617

https://github.com/NixOS/nixpkgs/issues/50105#issuecomment-1666398133
この時点で180以上のPRを提出し、自分以外のPRを180弱レビューし、70個のパッケージをメンテナンスしていた。
本日あらためて見てみると401のPRを提出し、1342のPRをレビューし、120のパッケージをメンテナンスしているらしい。

## コミッターになってから

大いなる力には大いなる責任が伴う。

上述したbotアカウントによる自動アップデートも確認するようになった。
これらは大量にあるが考えなしにマージすることができないという点が厄介である。
ほとんどのパッケージが使ったことのない名前も聞いたことがないパッケージであるが、最低限ChangeLogとDiffを確認している。

macOSのサポートをより良くするためにmac miniも購入した。

## 終わりに
